import React, { Component } from 'react';
import Select from 'react-select';
import './App.css';
import { firebaseConfig } from '../../utils/config';
import firebase from 'firebase';
import {Bar} from 'react-chartjs-2';
import { TwitterTimelineEmbed, TwitterShareButton, TwitterFollowButton, TwitterHashtagButton, TwitterMentionButton, TwitterTweetEmbed, TwitterMomentShare, TwitterDMButton, TwitterVideoEmbed, TwitterOnAirButton } from 'react-twitter-embed';
import Iframe from "react-iframe";
import "react-svg-map/lib/index.css";

const data = {
    labels: [],
    datasets: [
        {
            label: '',
            backgroundColor: 'rgba(255,99,132,0.2)',
            borderColor: 'rgba(255,99,132,1)',
            // borderWidth: 1,
            hoverBackgroundColor: 'rgba(255,99,132,0.4)',
            hoverBorderColor: 'rgba(255,99,132,1)',
            data: []
        }
    ]
};

const options = [
    { value: 'skopje', label: 'Skopje' },
    { value: 'bitola', label: 'Bitola' },
    { value: 'radovis', label: 'Radovis' },
];

class App extends Component {

    constructor(props) {
        super(props);

        this.app = firebase.initializeApp(firebaseConfig);
        this.database = this.app.database().ref().child("speed");

        this.state = {
            pm10: null,
            pm25: null,
            aqi: null,
            city_name: null,
            value: '',
            selectedOption: null,
            speed: 10
        };
    }

    readUserData(city_name){
        firebase.database().ref(city_name + "/").child(this.getKey().toString()).once('value', (snapshot) => {
            if(snapshot.exists()){
                console.log("Exists");
                this.setState({ pm10: snapshot.val().pm10 });
                this.setState({ pm25: snapshot.val().pm25 });
                this.setState({ aqi: snapshot.val().aqi });
                this.setState({city_name: city_name});
            }
            else {
                this.getRequest(city_name);
                console.log("Created");
            }

            // this.setState({ pm10: snapshot.val().pm10 });
            // this.setState({ pm25: snapshot.val().pm25 });
            // this.setState({ aqi: snapshot.val().aqi });
            // this.setState({city_name: city_name});
        })
    }

    writeUserData(city_name, key, pm10, pm25, aqi){
        firebase.database().ref(city_name + "/").child(key).set({
            pm10,
            pm25,
            aqi
        }).then((data) => {
            console.log(data)
        }).catch((error) => {
            console.log("error ", error)
        })
    }

    getKey(){
        let d = new Date();
        let path = d.toLocaleDateString().toString().split("/").join("-") + "T" + (d.getHours()).toString() + ":00";
        return path;
    }

    componentDidMount(){
        console.log(this.getKey());

        this.getRequest("Skopje");

        this.database.on('value', snap => {
            this.setState({
                speed: snap.val()
            });
        });

        // this.writeUserData("Skopje", "TTTTT", "test@g.com", "asd", "fgh");

        // this.database.on('child_added', snap => {
        //     previous.push({
        //         speed: 5
        //     })
        // })
    }

    handleChange = selectedOption => {
        this.setState({ selectedOption });
        this.readUserData(selectedOption.label);
        console.log(`Option selected:`, selectedOption.label);
    };

    getRequest(city){
        let path = "https://api.weatherbit.io/v2.0/current/airquality?city=" + city + "&country=MK&key=498f03aff502413dadf98ed9124ca628";
        fetch(path)
            .then(res => res.json())
            .then((data) => {
                console.log("IMINIMIN");
                this.writeUserData(city, this.getKey().toString(), data.data[0].pm10, data.data[0].pm25, data.data[0].aqi);
                this.setState({ pm10: data.data[0].pm10 });
                this.setState({ pm25: data.data[0].pm25 });
                this.setState({ aqi: data.data[0].aqi });
                this.setState({ city_name: data.city_name})
            });

    }

    render() {
        const { selectedOption } = this.state;
        data.labels = ["PM10", "PM25", "AQI"];
        data.datasets[0].data=[this.state.pm10, this.state.pm25, this.state.aqi];

        return (

            <div>
                <Select
                    value={selectedOption}
                    onChange={this.handleChange}
                    options={options}
                />

                <table className="table" width={"50%"}>
                    <thead className="thead-dark">
                    <tr>
                        <th width={"100px"}>City name</th>
                        <td>{this.state.city_name}</td>
                    </tr>
                    <tr>
                        <th>PM10</th>
                        <td>{this.state.pm10}</td>
                    </tr>
                    <tr>
                        <th>PM25</th>
                        <td>{this.state.pm25}</td>
                    </tr>
                    <tr>
                        <th>AQI</th>
                        <td>{this.state.aqi}</td>
                    </tr>
                    </thead>
                </table>

                <div style={{width: 555}}>
                <Bar data={data} />
                </div>

                <Iframe url="https://www.sociablekit.com/app/embed/index.php?embed_id=30223"
                        id="myId"
                        className="twitterWidget"
                        display="initial"
                        position="relative"/>

                            <svg baseProfile="tiny" fill="#7c7c7c" stroke="#ffffff" stroke-linecap="round"
                                 stroke-linejoin="round" stroke-width="2" version="1.2" className="map_svg" viewBox="0 0 1000 791"
                                 xmlns="http://www.w3.org/2000/svg">

                                //Berovo
                                <a href = "">
                                <polygon points="520,164, 519,163, 518,158, 515,159, 514,158, 510,158, 509,156, 509,153, 508,153, 499,131, 497,132, 496,128, 496,127, 492,129, 486,139, 461,135, 464,143, 460,151, 454,153, 457,179, 507,199, 506,190, 508,188, 513,189, 512,186, 513,186, 520,175, 521,175, 523,173, 520,164"/>
                                </a>

                                //Bitola
                                <a href="">
                                <polygon points="299,319, 303,325, 300,327, 301,328, 299,332, 301,337, 298,340, 295,339, 295,343, 288,348, 288,349, 279,356, 279,363, 276,367, 269,368, 266,366, 265,367, 259,363, 259,364, 257,364, 253,372, 253,373, 253,374, 247,375, 238,383, 236,382, 233,383, 224,372, 207,370, 172,384, 170,384, 169,381,
                                161,378, 159,380, 158,380, 165,354, 137,300, 183,265, 184,265, 193,261, 299,319"/>
                                </a>

                                <a href="">
                                //Valandovo
                                <polygon points="398,256, 397,256, 397,256, 389,248, 387,237, 398,225, 398,225, 413,222, 419,226, 419,226, 419,226, 419,226, 422,260, 438,272, 451,269, 451,269, 470,271, 468,276, 469,279, 469,282, 447,286, 443,292, 423,300, 423,300, 423,300, 421,281, 420,280, 417,274, 417,266, 417,266, 417,266, 398,256"/>
                                </a>

                                //Veles
                                <polygon points="333,184, 327,196, 326,204, 320,211, 320,211, 320,219, 312,219, 309,226, 294,223, 285,228, 284,228, 283,228, 279,218, 274,214, 256,228, 238,215, 230,214, 221,209, 205,187, 197,187, 204,160, 210,160, 219,150, 247,152, 252,142, 251,136, 272,139, 271,129, 280,115, 285,114, 299,130, 300,133,
                                297,144, 300,148, 294,154, 304,161, 302,162, 303,174, 316,178, 319,169, 330,168, 328,173, 323,178, 333,184"/>

                                //Vinica
                                <polygon points="467,114, 461,135, 464,143, 460,151, 454,153, 432,145, 429,149, 419,142, 414,142, 417,128, 414,122, 418,104, 424,109, 431,106, 437,104, 438,101, 446,100, 450,109, 467,114"/>

                                //Gevgelija
                                <polygon points="423,300, 443,292, 447,286, 469,282, 468,287, 467,286, 460,291, 459,300, 464,304, 464,304, 463,313, 460,314, 459,315, 450,303, 448,304, 435,320, 431,319, 429,317, 414,320, 407,319, 406,320, 400,320, 398,317, 398,316, 393,316, 391,315, 390,317, 387,316, 384,317, 384,319, 383,319, 382,312,
                                380,313, 375,311, 378,285, 381,283, 382,275, 388,272, 389,267, 388,257, 395,259, 397,256, 398,256, 417,266, 417,266, 417,274, 420,280, 421,281, 423,300, 423,300, 423,300"/>

                                //Gostivar
                                <polygon points="140,136, 142,143, 138,144, 130,157, 133,170, 118,173, 113,170, 91,169, 78,175, 84,185, 79,201, 70,209, 59,210, 47,198, 40,196, 26,181, 27,178, 24,167, 29,157, 28,156, 31,153, 36,152, 33,134, 40,131, 46,138, 51,133, 58,136, 66,131, 68,131, 74,124, 92,135, 128,128, 140,136"/>

                                //Debar
                                <polygon points="47,198, 59,210, 54,213, 50,225, 45,229, 22,231, 21,228, 15,226, 17,223, 12,222, 12,220, 14,218, 16,217, 13,212, 19,211, 33,205, 26,191, 25,185, 26,181, 40,196, 47,198"/>

                                //Delcevo
                                <polygon points="496,127, 496,127, 492,129, 486,139, 461,135, 467,114, 450,109, 446,100, 438,101, 437,104, 431,106, 422,87, 417,84, 415,80, 414,75, 410,71, 409,68, 421,64, 434,74, 435,74, 439,77, 441,77, 447,81, 447,82, 451,83, 452,85, 460,83, 460,85, 465,90, 466,89, 472,91, 476,91, 476,89, 481,95, 486,96,
                                487,95, 489,95, 490,96, 488,100, 491,101, 492,119, 495,121, 496,127"/>

                                //Demir Hisar
                                <polygon points="183,265, 137,300, 130,281, 123,277, 104,255, 123,243, 133,244, 143,234, 152,239, 158,246, 166,249, 166,255, 171,256, 183,265"/>

                                //Kavadarci
                                <polygon points="285,228, 294,223, 309,226, 312,219, 320,219, 320,211, 332,211, 334,232, 348,238, 347,251, 376,261, 381,255, 388,257, 389,267, 388,272, 382,275, 381,283, 378,285, 375,311, 373,311, 372,309, 368,308, 361,307, 359,309, 352,311, 351,312, 348,318, 344,319, 337,315, 336,315, 334,313, 333,311,
                                  330,309, 324,316, 319,317, 314,318, 313,317, 312,318, 315,298, 301,282, 284,228, 285,228"/>

                                //Kicevo
                                <polygon points="158,225, 150,224, 148,229, 145,229, 143,234, 133,244, 123,243, 104,255, 92,225, 74,222, 50,225, 54,213, 59,210, 70,209, 79,201, 84,185, 78,175, 91,169, 113,170, 118,173, 133,170, 140,178, 145,179, 148,200, 139,208, 133,210, 134,214, 143,214, 158,225"/>

                                //Kocani
                                <polygon points="422,87, 431,106, 424,109, 418,104, 414,122, 417,128, 414,142, 402,142, 370,127, 369,127, 365,116, 388,94, 392,86, 391,85, 393,85, 396,80, 394,75, 410,71, 414,75, 415,80, 417,84, 422,87"/>

                                //Kratovo
                                <polygon points="333,63, 358,72, 368,67, 381,67, 390,74, 394,75, 396,80, 393,85, 391,85, 375,86, 371,91, 366,93, 362,89, 357,87, 330,93, 321,93, 321,90, 311,84, 312,73, 321,70, 328,58, 332,62, 333,63"/>

                                //Kriva Palanka
                                <polygon points="421,64, 409,68, 410,71, 394,75, 390,74, 381,67, 368,67, 358,72, 333,63, 332,62, 330,52, 338,24, 339,23, 342,23, 345,24, 347,21, 351,23, 356,17, 358,16, 366,15, 365,14, 369,10, 372,11, 380,8, 380,8, 376,13, 389,23, 393,24, 398,29, 397,30, 405,38, 405,39, 411,51, 417,52, 418,53, 417,54, 420,62,
                                419,63, 421,64"/>

                                //Krusevo
                                <polygon points="191,253, 193,261, 184,265, 183,265, 171,256, 166,255, 166,249, 158,246, 152,239, 143,234, 145,229, 148,229, 150,224, 158,225, 170,218, 176,219, 179,227, 172,231, 181,233, 191,252, 191,253"/>

                                //Kumanovo
                                <polygon points="225,41, 228,40, 230,40, 236,36, 239,37, 242,36, 260,43, 264,35, 271,37, 277,27, 282,28, 287,20, 297,26, 305,24, 306,16, 307,15, 322,24, 328,24, 337,26, 338,24, 330,52, 332,62, 328,58, 321,70, 312,73, 311,84, 321,90, 321,93, 317,98, 296,94, 292,106, 287,109, 253,92, 246,92, 240,96, 230,94,
                                224,76, 215,69, 224,56, 220,53, 218,46, 225,41, 225,41"/>

                                //Makedonski brod
                                <polygon points="174,132, 193,157, 203,157, 204,160, 197,187, 197,188, 196,188, 191,208, 185,207, 179,211, 177,210, 170,218, 158,225, 143,214, 134,214, 133,210, 139,208, 148,200, 145,179, 140,178, 133,170, 130,157, 138,144, 142,143, 144,142, 162,129, 173,131, 174,132"/>

                                //Negotino
                                <polygon points="397,256, 397,256, 395,259, 388,257, 381,255, 376,261, 347,251, 348,238, 334,232, 332,211, 320,211, 320,211, 326,204, 327,196, 333,184, 323,178, 328,173, 343,180, 347,176, 351,184, 360,187, 367,195, 373,197, 381,193, 396,212, 398,225, 398,225, 387,237, 389,248, 397,256"/>

                                //Ohrid
                                <polygon points="89,339, 90,365, 90,365, 86,373, 82,375, 69,372, 78,367, 81,328, 84,325, 84,323, 81,322, 71,310, 63,308, 63,287, 72,264, 61,261, 50,225, 74,222, 92,225, 104,255, 123,277, 117,291, 93,312, 89,339"/>

                                //Prilep
                                <polygon points="179,211, 185,207, 191,208, 196,188, 197,188, 197,187, 205,187, 221,209, 230,214, 238,215, 256,228, 274,214, 279,218, 283,228, 284,228, 301,282, 315,298, 312,318, 303,325, 299,319, 193,261, 191,253, 191,252, 181,233, 172,231, 179,227, 176,219, 170,218, 177,210, 179,211"/>

                                //Probistip
                                <polygon points="391,85, 392,86, 388,94, 365,116, 369,127, 347,122, 349,116, 330,93, 357,87, 362,89, 366,93, 371,91, 375,86, 391,85"/>

                                //Radovis
                                <polygon points="419,226, 419,226, 413,222, 398,225, 396,212, 381,193, 387,192, 394,182, 386,175, 397,164, 405,166, 411,165, 412,148, 415,144, 419,142, 429,149, 432,145, 454,153, 457,179, 449,179, 459,197, 454,203, 440,193, 430,203, 430,221, 422,218, 419,226"/>

                                //Resen
                                <polygon points="107,366, 110,366, 119,372, 116,375, 114,372, 113,372, 109,369, 104,369, 103,370, 90,365, 89,339, 93,312, 117,291, 123,277, 130,281, 137,300, 165,354, 158,380, 155,381, 151,385, 144,385, 141,376, 125,347, 119,345, 111,347, 101,358, 100,359, 107,366"/>

                                //SvNikole
                                <polygon points="319,167, 319,169, 316,178, 303,174, 302,162, 304,161, 294,154, 300,148, 297,144, 300,133, 299,130, 285,114, 285,113, 287,109, 292,106, 296,94, 317,98, 321,93, 330,93, 349,116, 347,122, 343,126, 345,136, 334,146, 338,149, 328,158, 319,155, 313,160, 319,167"/>

                                //Skopje
                                <polygon points="181,76, 184,74, 182,71, 179,66, 186,51, 189,50, 196,40, 202,40, 205,44, 209,41, 206,38, 208,33, 213,34, 214,31, 221,34, 225,41, 218,46, 220,53, 224,56, 215,69, 224,76, 230,94, 240,96, 246,92, 253,92, 287,109, 285,113, 285,114, 280,115, 271,129, 272,139, 251,136, 252,142, 247,152, 219,150,
                                210,160, 204,160, 203,157, 193,157, 174,132, 174,117, 160,112, 164,93, 160,87, 155,85, 156,79, 164,77, 164,77, 179,75, 180,73, 181,73, 181,76"/>

                                //Struga
                                <polygon points="72,264, 63,287, 63,308, 56,306, 52,308, 51,315, 50,316, 49,327, 40,326, 38,322, 39,319, 39,319, 41,318, 40,316, 40,315, 39,315, 36,308, 35,308, 35,307, 33,304, 33,301, 32,302, 30,301, 30,301, 29,301, 20,267, 22,263, 26,265, 29,260, 31,254, 34,249, 29,243, 24,241, 24,241, 23,239, 24,237,
                                22,231, 45,229, 50,225, 61,261, 72,264"/>

                                //Strumica
                                <a href="https://www.w3schools.com">
                                <polygon points="509,234, 511,240, 510,242, 509,242, 507,246, 507,247, 508,248, 509,262, 502,265, 494,265, 488,266, 481,266, 479,264, 478,265, 475,267, 475,268, 470,268, 470,269, 470,271, 470,271, 451,269, 451,269, 438,272, 422,260, 419,226, 419,226, 419,226, 419,226, 419,226, 422,218, 430,221, 430,203,
                                440,193, 454,203, 459,197, 449,179, 457,179, 507,199, 507,204, 509,206, 509,208, 511,210, 510,215, 508,215, 508,217, 510,221, 508,231, 510,232, 509,234"/>
                                </a>

                                //Tetovo
                                <polygon points="174,117, 174,132, 173,131, 162,129, 144,142, 142,143, 140,136, 128,128, 92,135, 74,124, 75,122, 78,121, 72,114, 74,111, 71,94, 74,90, 73,88, 79,80, 88,80, 90,76, 98,77, 104,72, 105,69, 144,49, 153,52, 162,67, 163,68, 164,77, 156,79, 155,85, 160,87, 164,93, 160,112, 174,117"/>

                                //Stip
                                <polygon points="414,142, 419,142, 415,144, 412,148, 411,165, 405,166, 397,164, 386,175, 394,182, 387,192, 381,193, 373,197, 367,195, 360,187, 351,184, 347,176, 343,180, 328,173, 330,168, 319,169, 319,167, 313,160, 319,155, 328,158, 338,149, 334,146, 345,136, 343,126, 347,122, 369,127, 370,127, 402,142,
                                414,142"/>


                            </svg>

                        </div>


        );
    }
}
export default App;